# README - DiFlex

DiFlex is a de novo meta-transcriptome assembly and differential gene expression pipeline. For the input the pipeline takes raw Illumina paired-end RNAseq libraries. The output contains the transcriptome assembly and the differential gene expression between treatments. It will also perform a functional protein analysis of the transcripts. The main tools that are used by the pipeline are FastQC, Trimmomatic, SortMeRNA, Trinity and Interproscan. DiFlex is a flexible, open source and user-friendly pipeline.

## Repo content

- `config.yaml` - Extention: the configuration file for parameteter specification of snakemake workflow.
- `db/` - Databases: adapters and sortmerna database.
- `envs/` - Conda environments in yaml format. These environments will be automatically installed when the pipeline is run.
- `report/` - Reports on the results and autogenerated snakemake report.
- `rules/` - Modular snakemake rules called by the snakefile.
- `scripts/` - Different scripts that are needed to run the pipeline.
- `sample-data/` - Tiny sample dataset with raw and trimmomatic filtered reads from two types of marine samples. Can be used for testing of workflow. Small enough to run on laptop.
- `samples.csv` - Tabular with sample information and link to associated input files. To be used in snakefile to initiate pipeline.
- `schemas/` - Extention: Config file of config to restrict allowed parameter formats and to set default values.
- `Snakefile` - Snakefile.
- `src/` - Source.

## Getting started

### Requirements

The pipeline has been created and tested on a Linux system.  
The pipeline requires the file samples.csv. The first must contain the following columns: run, sample type, sample, forward and reverse. The columns forward and reverse consists of the pathnames of the samples. 
To run the pipeline, the required files need to be in the same path as given in the config.yaml. 
DiFlex makes use of the tool Snakemake. 

### Installation

DiFlex the Snakemake en Conda installation can be found in the following links.  
- [Snakemake installation](https://snakemake.readthedocs.io/en/stable/getting_started/installation.html) 
- [Conda installation](https://docs.conda.io/projects/conda/en/latest/user-guide/install/linux.html)

You can either clone DiFlex, like so: 
```bash
git clone https://github.com/ejongepier/metatrans-smk-hs.git  
```
or download and extract the zip archive [DiFlex](https://github.com/ejongepier/metatrans-smk-hs)  
DiFlex is immediately ready to use. 

## Usage 

### Quick start

The file samples.csv needs to be in the same path as given in the config.yaml. 
To run snakemake, you simple run the next command: 
```bash 
snakemake --use-conda --cores <ncores> 
```
Where ncores are the number of the CPU cores/jobs that can be run in parallel on your system. 

If you wish to use the SLURM job scheduler to run the pipeline on a cluster than access the jobscript.sh script in the scripts folder and change the variables at the top of the script to the resources you have available. You must also change the paths containing the pipeline and snakemake environment. Then use the following command: 
```bash
sbatch scripts/jobscript.sh <configfile>
```
Where configfile is the config.yaml file included in the pipeline.

### Customizing

You can customize the pipeline through the config.yaml, for example, by changing the number of the threads per process. 
For details in how to customize the sample.csv see the help function in the pipeline. 
To invoke the help function, please use the following command line: 
```bash
snakemake --use-conda --cores <ncores> help 
```

### Report

The report will show a workflow of the pipeline. It will also contain the statistic and configuration. In the statistics, the runtime and the creating date is available. The config.yaml will be shown in the configuration.  
After running the pipeline, a report can be formed with the next command line: 
snakemake --report reports/report.zip 

### Output

The results directory contains the output files per rule. The words between {} are different based on what the user specified in the samples.csv. 

The rule FastQC creates a FastQC report in html format for each sample. FastQC is a quality control for high throughput sequence data. It provides a set of modular analysis. Through these analyses is it possible to quickly understand if there are any problems with the data. There are two functions of the FastQC. One for the raw data and one for the trimmed data. The input data of both rules contains the direction of the samples, and the output data is a directory consists of the results of the analyses of every sample.

The rule Trimmomatic performs adapter trimming and quality filtering to trimmed reads in FastQ format. 

The rule SortMeRNA filters the reads to only include mRNA reads to use in the trinity assembly. 

The rule Trinity assembly creates the trinity assemble directory. It will look for overlay between the sequences. The overlay determined the order in which the sequences originally will be. Due this the original sequence will be formed. The input is the trimmomatic trimmed libraries. The ouput will generate a directory for the two outputfiles: Trinity.fasta and Trinity_stats.txt. The Trinity.fasta is a FASTA file with assembled transcripts. The file Trinity._stats.txt contains the statics of the assembled transcripts.

Trinity DE performs the differential expression on the trimmed data. First, the assembly data is aligned using bowtie2 and an abundance estimation is done using RSEM. This output is used to make matrices of the isoform and gene data. Afterwards the DE analysis is made for both the isoform and gene data. Both use their respective counts matrix. Both analyses are performed using edgeR. A differential expression analysis is also made using the TMM matrices of both the isoform and gene data.

Interproscan makes use of the InterPro database to perform functional analysis of the translated transcripts from the trinity assembly. It can perform multiple analysis which are listed in the config file. For multiple reasons the following analysis are not avaiable: PANTHER, MOBIDB PROSITEPATTERNS, PROSITEPROFILES and SUPERFAMILY. 

#### Overview outputfiles: 
- Quality control of raw input libraries generated with fastqc: 
   * results/{run}/fastqc/raw/{sample}/ 
- Adapter and quality trimmed read libraries generated with trimmomatic:
    * results/{run}/trimmomatic/{sample}.R1.paired.fastq.gz 
    * results/{run}/trimmomatic/{sample}.R2.paired.fastq.gz 
    * results/{run}/trimmomatic/{sample}.R1.unpaired.fastq.gz 
    * results/{run}/trimmomatic/{sample}.R2.unpaired.fastq.gz 
- RNA filtering of the trimmed reads 
    * results/{run}/sortmerna/{sample}/paired_left.fq.gz 
    * results/{run}/sortmerna/{sample}/paired_right.fq.gz 
- Quality control of trimmed and filtered input libraries generated with fastqc: 
    * results/{run}/fastqc/trimmed_filtered/{sample}/ 
- Overlaps of trimmed input libraries generated with trinity assembly: 
    * results/{run}/trinity_output/trinity_assemble/Trinity.fasta 
    * results/{run}/trinity_output/trinity_assemble/Trinity_stats.txt 
- Differential gene expression of the assembly data with trinity DE: 
    * diffExpr.P0.01_C1.0.matrix.log2.centered.genes_vs_samples_heatmap.pdf 
    * diffExpr.P0.01_C1.0.matrix.log2.centered.sample_cor_matrix.pdf 
    * trinity-de.gene.counts.matrix.C_vs_MA.edgeR.DE_results.MA_n_Volcano.pdf 
    * trinity-de.gene.TMM.EXPR.matrix.log2.prcomp.principal_components.pdf 
    * diffExpr.P0.01_C1.0.matrix.log2.centered.genes_vs_samples_heatmap.pdf 
    * diffExpr.P0.01_C1.0.matrix.log2.centered.sample_cor_matrix.pdf 
    * trinity-de.isoform.counts.matrix.C_vs_MA.edgeR.DE_results.MA_n_Volcano.pdf 
    * trinity-de.isoform.TMM.EXPR.matrix.log2.prcomp.principal_components.pdf 
- Functional protein analysis with Interproscan 
    * results/{run}/interproscan/interproscan_output/output.tsv 
- Graphical overview of sample read count remaining after the different methods 
    * results/{run}/plots/processed_reads.pdf 
    * results/{run}/plots/reads_by_sample.pdf 

## Authors

* Evelien Jongepier (e.jongepier@uva.nl)
* Chezley van Veen (s1107623@student.hsleiden.nl) 
* Noa van Daatselaar (s1117684@student.hsleiden.nl) 
* Thomas den Hamer (s1118639@student.hsleiden.nl) 
* Selena Impink (s1119647@student.hsleiden.nl) 


